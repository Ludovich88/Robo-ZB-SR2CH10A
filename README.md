# Умное реле ESP32-C6 с поддержкой Zigbee и энергомониторинга

Это прошивка для умного реле на базе ESP32-C6 с поддержкой протокола Zigbee и микросхемы энергомониторинга BL0940.

## Функциональность

- **2 канала реле** с независимым управлением
- **Zigbee подключение** для интеграции в умный дом
- **Энергомониторинг** через микросхему BL0940
- **Zero-cross детектор** для синхронизации с AC сетью
- **Локальное управление** через физические переключатели
- **Индикация состояния** через LED

## Схема подключения

| GPIO | Назначение | Описание |
|------|------------|----------|
| IO0  | BUTTON_PAIRING | Кнопка для запуска пейринга Zigbee |
| IO1  | LED_STATUS | Индикатор состояния связи |
| IO2  | ZERO_CROSS | Сигнал zero-cross от AC сети |
| IO4  | UART_RX | Прием данных от BL0940 |
| IO5  | UART_TX | Передача команд к BL0940 |
| IO14 | SWITCH_1 | Внешний переключатель реле 1 |
| IO15 | SWITCH_2 | Внешний переключатель реле 2 |
| IO18 | RELAY_2 | Управление реле 2 |
| IO19 | RELAY_1 | Управление реле 1 |

## Требования

- ESP-IDF версии 5.0.0 или выше
- ESP32-C6 Development Board
- Микросхема энергомониторинга BL0940
- 2 реле модуля
- Кнопка и LED для индикации
- Датчик zero-cross

## Установка и настройка

### 1. Установка ESP-IDF

```bash
# Клонируйте ESP-IDF
git clone --recursive https://github.com/espressif/esp-idf.git
cd esp-idf

# Установите ESP-IDF
./install.sh

# Активируйте окружение
source export.sh
```

### 2. Клонирование проекта

```bash
git clone <your-repo-url>
cd Robo-ZB-SR2CH10A
```

### 3. Настройка проекта

```bash
# Настройте проект
idf.py set-target esp32c6
idf.py menuconfig
```

В меню конфигурации настройте:
- **Component config → ESP32C6-Specific → CPU Frequency**: 160MHz
- **Component config → ESP32C6-Specific → Flash Size**: 4MB
- **Component config → ESP32C6-Specific → PSRAM**: Disabled
- **Component config → ESP32C6-Specific → UART Console**: UART0

### 4. Компиляция

```bash
# Соберите проект
idf.py build
```

### 5. Прошивка

#### Подключение к ESP32-C6

1. Подключите USB-C кабель к ESP32-C6
2. Убедитесь, что драйверы установлены
3. Определите COM порт в диспетчере устройств

#### Прошивка через ESP-IDF

```bash
# Прошивка основной прошивки
idf.py flash

# Прошивка с мониторингом
idf.py flash monitor

# Полная прошивка (bootloader + partition table + app)
idf.py -p COM3 flash
```

#### Прошивка через ESP-IDF Flash Download Tool

1. Запустите `idf.py build`
2. Откройте ESP-IDF Flash Download Tool
3. Укажите пути к файлам:
   - **Bootloader**: `build/bootloader/bootloader.bin`
   - **Partition Table**: `build/partition-table.bin`
   - **Application**: `build/Robo_SR2CH_10A.bin`
4. Установите адреса:
   - Bootloader: `0x0`
   - Partition Table: `0x8000`
   - Application: `0x10000`
5. Нажмите "START" для прошивки

### 6. Мониторинг и отладка

```bash
# Мониторинг через последовательный порт
idf.py monitor

# Мониторинг с автоматическим перезапуском
idf.py monitor --monitor-command "esp32c6 monitor"
```

## Использование

### Пейринг Zigbee

1. Нажмите кнопку на IO0 (BUTTON_PAIRING)
2. LED на IO1 начнет быстро мигать
3. В вашей Zigbee сети (например, Home Assistant) добавьте новое устройство
4. Устройство появится как "On/Off Switch"

### Управление реле

- **Через Zigbee**: отправляйте команды on/off через вашу Zigbee сеть
- **Локально**: используйте физические переключатели на IO14 и IO15
- **Программно**: через API или веб-интерфейс

### Энергомониторинг

Данные от BL0940 автоматически считываются и передаются через Zigbee:
- Напряжение (мВ)
- Ток (мА)
- Мощность (мВт)
- Энергия (мВт·ч)

## Структура кода

```
main/
├── Robo_SR2CH_10A.c    # Основной файл прошивки
├── CMakeLists.txt       # Конфигурация сборки
└── idf_component.yml    # Зависимости компонентов

CMakeLists.txt           # Основной CMakeLists
sdkconfig               # Конфигурация SDK
```

## Основные компоненты кода

1. **GPIO инициализация** - настройка всех пинов
2. **UART для BL0940** - связь с микросхемой энергомониторинга
3. **Zigbee стек** - протокол связи
4. **FreeRTOS задачи** - параллельная обработка событий
5. **GPIO прерывания** - обработка кнопок и переключателей

## Отладка

### Частые проблемы

1. **Ошибка компиляции Zigbee библиотек**
   - Убедитесь, что ESP-IDF версии 5.0+
   - Проверьте зависимости в `idf_component.yml`

2. **Ошибка прошивки**
   - Проверьте подключение USB
   - Убедитесь, что ESP32-C6 в режиме загрузки
   - Попробуйте удерживать BOOT кнопку при прошивке

3. **Zigbee не подключается**
   - Проверьте LED индикатор
   - Убедитесь, что рядом есть Zigbee координатор
   - Попробуйте перезапустить пейринг

### Логи

Логи выводятся через последовательный порт:
- **INFO**: общая информация о работе
- **WARN**: предупреждения
- **ERROR**: ошибки

## Лицензия

Этот проект распространяется под лицензией MIT.

## Поддержка

При возникновении проблем:
1. Проверьте логи через `idf.py monitor`
2. Убедитесь в правильности подключения
3. Проверьте версии ESP-IDF и зависимостей
4. Создайте issue в репозитории проекта