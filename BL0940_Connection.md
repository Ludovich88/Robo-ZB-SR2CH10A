# Подключение микросхемы энергомониторинга BL0940

## Описание BL0940

BL0940 - это высокоточная микросхема для измерения электрических параметров в однофазных сетях переменного тока. Она измеряет:
- Действующее значение напряжения (RMS)
- Действующее значение тока (RMS)
- Активную мощность
- Энергию
- Коэффициент мощности

## Схема подключения

### Питание BL0940
```
VDD (BL0940) ---- 3.3V (ESP32-C6)
GND (BL0940) ---- GND (ESP32-C6)
```

### UART подключение
```
TX (BL0940) ---- GPIO4 (RX) ESP32-C6
RX (BL0940) ---- GPIO5 (TX) ESP32-C6
```

### Измерение напряжения
```
L (AC Line) ---- R1 (1MΩ) ---- R2 (1kΩ) ---- GND
                |
                +---- R3 (1kΩ) ---- V1P (BL0940)
                |
                +---- R4 (1kΩ) ---- V1N (BL0940)
```

### Измерение тока
```
L (AC Line) ---- CT (Current Transformer) ---- R5 (100Ω) ---- GND
                |
                +---- I1P (BL0940)
                |
                +---- I1N (BL0940)
```

## Детали компонентов

### Резисторы для делителя напряжения
- R1: 1MΩ, 1W
- R2: 1kΩ, 0.25W
- R3: 1kΩ, 0.25W
- R4: 1kΩ, 0.25W

### Токовый трансформатор
- CT: 100A:50mA или 50A:25mA
- R5: 100Ω, 1W (шунтирующий резистор)

### Конденсаторы
- C1: 100nF между VDD и GND
- C2: 100nF между V1P и V1N
- C3: 100nF между I1P и I1N

## Настройка BL0940

### Регистры конфигурации

```c
// Пример настройки BL0940 через UART
void configure_bl0940(void) {
    uint8_t config_cmd[] = {
        0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    
    // Отправка команды конфигурации
    uart_write_bytes(UART_NUM_1, config_cmd, sizeof(config_cmd));
}
```

### Формат данных BL0940

BL0940 отправляет данные в следующем формате:
```
Byte 0: 0x58 (Start byte)
Byte 1-2: Voltage RMS (16-bit, big-endian)
Byte 3-4: Current RMS (16-bit, big-endian)
Byte 5-6: Active Power (16-bit, big-endian)
Byte 7: Checksum
```

## Расчеты

### Напряжение
```
V_rms = (ADC_value * V_ref) / (2^15 * Gain)
```

### Ток
```
I_rms = (ADC_value * V_ref) / (2^15 * Gain * CT_ratio)
```

### Мощность
```
P = V_rms * I_rms * cos(φ)
```

## Безопасность

⚠️ **ВАЖНО**: При работе с высоким напряжением соблюдайте меры безопасности:

1. **Всегда отключайте питание** перед подключением/отключением
2. **Используйте изолирующие перчатки** при работе с AC
3. **Проверяйте все соединения** перед включением
4. **Используйте предохранители** для защиты
5. **Работайте в сухом помещении** без металлических поверхностей

## Тестирование

### Проверка подключения
1. Подключите BL0940 к ESP32-C6
2. Запустите прошивку
3. Проверьте логи через `idf.py monitor`
4. Убедитесь, что данные поступают

### Калибровка
1. Измерьте реальное напряжение мультиметром
2. Сравните с показаниями BL0940
3. При необходимости скорректируйте коэффициенты в коде

## Устранение неполадок

### BL0940 не отвечает
- Проверьте подключение питания
- Убедитесь в правильности UART подключения
- Проверьте скорость UART (4800 baud)

### Неверные показания
- Проверьте делитель напряжения
- Убедитесь в правильности CT
- Проверьте калибровку

### Помехи в измерениях
- Добавьте фильтрующие конденсаторы
- Улучшите экранирование
- Увеличьте емкость фильтров
