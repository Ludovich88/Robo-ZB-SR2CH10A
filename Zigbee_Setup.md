# Настройка Zigbee подключения

## Обзор

Данное умное реле использует протокол Zigbee для интеграции в умный дом. Устройство работает в режиме End Device (ED) и подключается к Zigbee координатору.

## Требования к Zigbee сети

### Координатор
- Zigbee координатор (например, Home Assistant Yellow, Sonoff Zigbee Bridge)
- Поддержка Zigbee 3.0
- Доступ к интернету для обновления прошивки

### Частоты
- 2.4 GHz (стандартная для Zigbee)
- Каналы 11-26 (в зависимости от региона)

## Процесс пейринга

### 1. Подготовка
1. Убедитесь, что Zigbee координатор работает
2. Проверьте, что в сети есть свободные слоты для устройств
3. Убедитесь, что устройство находится в зоне действия координатора

### 2. Запуск пейринга
1. **На устройстве**: Нажмите кнопку на GPIO0 (BUTTON_PAIRING)
2. **Индикация**: LED на GPIO1 начнет быстро мигать
3. **Время**: У вас есть 60 секунд для завершения пейринга

### 3. Добавление в сеть
1. В интерфейсе координатора выберите "Добавить устройство"
2. Выберите тип устройства: "On/Off Switch" или "Relay"
3. Дождитесь обнаружения устройства
4. Подтвердите добавление

## Управление через Zigbee

### Команды On/Off
```json
{
  "cluster": "genOnOff",
  "command": "toggle",
  "endpoint": 1
}
```

### Чтение состояния
```json
{
  "cluster": "genOnOff",
  "command": "read",
  "attribute": "onOff",
  "endpoint": 1
}
```

### Установка состояния
```json
{
  "cluster": "genOnOff",
  "command": "write",
  "attribute": "onOff",
  "value": true,
  "endpoint": 1
}
```

## Интеграция с Home Assistant

### 1. Установка ZHA
```yaml
# configuration.yaml
zha:
  usb_path: /dev/ttyUSB0
  database_path: /config/zigbee.db
```

### 2. Добавление устройства
1. Откройте Home Assistant
2. Перейдите в Настройки → Устройства и службы
3. Нажмите "Добавить интеграцию"
4. Выберите "Zigbee Home Automation"
5. Следуйте инструкциям по настройке

### 3. Автоматизация
```yaml
# automation.yaml
- alias: "Включить реле при движении"
  trigger:
    platform: state
    entity_id: binary_sensor.motion_sensor
    to: "on"
  action:
    service: switch.turn_on
    target:
      entity_id: switch.smart_relay_1
```

## Интеграция с другими системами

### OpenHAB
1. Установите Zigbee binding
2. Настройте координатор
3. Добавьте устройство через пейринг

### Node-RED
1. Установите node-red-contrib-zigbee
2. Настройте координатор
3. Используйте zigbee-in и zigbee-out узлы

## Устранение неполадок

### Устройство не подключается
1. **Проверьте расстояние**: Убедитесь, что устройство в зоне действия
2. **Проверьте помехи**: Уберите WiFi роутеры и другие 2.4GHz устройства
3. **Перезапустите пейринг**: Нажмите кнопку пейринга снова
4. **Проверьте логи**: Используйте `idf.py monitor`

### Нестабильная связь
1. **Улучшите размещение**: Переместите координатор ближе к устройству
2. **Добавьте повторители**: Используйте Zigbee Router устройства
3. **Проверьте питание**: Убедитесь в стабильном питании координатора

### Устройство отключается
1. **Проверьте питание**: Убедитесь в стабильном питании ESP32-C6
2. **Проверьте антенну**: Убедитесь, что антенна не повреждена
3. **Обновите прошивку**: Проверьте наличие обновлений

## Безопасность

### Шифрование
- Zigbee 3.0 использует AES-128 шифрование
- Все команды шифруются по умолчанию
- Ключи обновляются автоматически

### Аутентификация
- Используйте Install Code для безопасного пейринга
- Не передавайте ключи третьим лицам
- Регулярно обновляйте прошивку

## Мониторинг

### Логи устройства
```bash
idf.py monitor
```

### Логи координатора
- Home Assistant: Логи → Zigbee
- OpenHAB: Логи системы
- Node-RED: Консоль отладки

### Статистика сети
- Количество устройств
- Качество связи
- Частота ошибок
- Время отклика

## Обновление прошивки

### OTA (Over-The-Air)
1. Подготовьте новую прошивку
2. Загрузите в координатор
3. Инициируйте обновление через интерфейс
4. Дождитесь завершения

### Локальное обновление
1. Подключите USB кабель
2. Используйте `idf.py flash`
3. Перезапустите устройство

## Рекомендации

### Размещение
- Размещайте координатор в центре дома
- Избегайте металлических препятствий
- Используйте повторители для больших помещений

### Настройка
- Используйте статические каналы WiFi
- Размещайте Zigbee устройства подальше от WiFi
- Регулярно проверяйте качество связи

### Обслуживание
- Регулярно обновляйте прошивку
- Мониторьте качество связи
- Ведите журнал изменений
